<script src="gameIO.js"></script>
<img id="car" src="img/car.png">
<img id="wheel" src="img/wheel.png">
<img id="dirt1" src="img/dirt1.png">
<img id="dirt2" src="img/dirt2.png">
<img id="dirt3" src="img/dirt3.png">
<img id="dirt4" src="img/dirt4.png">
<img id="smoke1" src="img/smoke1.png">
<img id="smoke2" src="img/smoke2.png">
<img id="smoke3" src="img/smoke3.png">
<style>
body {
	margin: 0;
	padding: 0;
	overflow: hidden;
}
canvas {
	position: absolute;
}
form {
	position: absolute;
}
input[type=text] {
	width: 200px;
	margin-left: -100px;
	height: 50px;
	margin-top: -75px;
	outline: none;
	font-size: 30px;
	color: #333;
	text-align: center;
	border: 1px solid black;
	top: 500px;
	left: 50%;
	position: fixed;
}
#enter-text {
	font-family: Arial;
	font-size: 24px;
	color: #FFF;
	top: 500px;
	left: 50%;
	transform: translateX(-50%);
	position: fixed;
}
#pregame-gui {
	visibility: visible;
}
#title-text {
	position: fixed;
	top: 100px;
	left: 50%;
	color: #FFF;
	font-size: 128px;
	font-family: Arial;
	transform: translateX(-50%);
}
</style>
<canvas id="canvas"></canvas>
<div id="pregame-gui">
	<span id="title-text">CarCar.io</span>
	<form onsubmit="playGame();return false;">
		<input type="text" id="nameText" placeholder="Name">
		<label id="enter-text">(Press enter to start)</label>
	</form>
</div>
<script>
	function getElem(elem) {
		return document.getElementById(elem);
	}
	function resizeGUI() {
		getElem("pregame-gui").style.transform = "scale(" + renderer.ratio + ")";
	}
	window.addEventListener('resize', resizeGUI);
	var game = new gameIO();
	getElem("nameText").focus();
	
	function playGame() {
		getElem("pregame-gui").style.visibility = "hidden";
		game.createSocket("ws://buuuuble.herokuapp.com");
		game.currentPackets.push({
			type: "playerJoin",
			name: getElem("nameText").value
		});
		main();
	}
	//basic stuff
	var renderer = new game.renderer(getElem("canvas"));
	renderer.clearScreen = false;
	renderer.ctx.imageSmoothingEnabled = false;
	renderer.c.style.backgroundColor = "#60CC56";
	var mouse = new game.mouse(renderer);
	var controls = new game.keyboard();
	resizeGUI();
	//scenes
	var tilesScene = new game.scene();
	var extrasScene = new game.scene();
	var scene = new game.scene();
	var guiScene = new game.scene();
	//GUI elements
	var lapCounterText = new game.text("",0,0,"#FFF");
	guiScene.add(lapCounterText);
	var placeText = new game.text("", 0, 0, "#FFF");
	guiScene.add(placeText);
	//misc
	var players = [];
	var gameOver = false;
	var gameOverText = new game.text("Game Over", 0, 0, "#E44", "Arial", 128);
	
	//particle functions
	var particles = [];
	function makeSmoke(x, y, num=1, xvel=2, yvel=-1) {
		var imgname = "smoke" + Math.floor(Math.random() * 3 + 1);
		var obj = new game.image(getElem(imgname), x, y);
		obj.width = obj.image.width * 5;
		obj.height = obj.image.height * 5;
		obj.xvel = Math.random() * xvel - xvel/2;
		obj.yvel = Math.random() * yvel;
		obj.rotationRate = Math.random() * 0.5 - 0.25;
		obj.dead = false;
		particles.push(obj);
		extrasScene.add(obj);
	}
	function makeDirt(x, y, num=1, xvel=2, yvel=-1) {
		var imgname = "dirt" + Math.floor(Math.random() * 4 + 1);
		var obj = new game.image(getElem(imgname), x, y);
		obj.width = obj.image.width * 5;
		obj.height = obj.image.height * 5;
		obj.xvel = Math.random() * xvel - xvel/2;
		obj.yvel = Math.random() * yvel;
		obj.rotationRate = Math.random() * 0.5 - 0.25;
		obj.dead = false;
		particles.push(obj);
		extrasScene.add(obj);
	}
	
	//game types
	game.addType(
		"player",
		function(obj, packet) {
			obj.vel = 0;
			obj.onTile = "empty";
			obj.laps = 0;
			obj.roadsToTouchLength = 0;
			obj.name = packet.playerName;
			
			obj.visual = new game.image(getElem("car"), 0, 0, getElem("car").width * 5, getElem("car").height * 5);
			obj.frontWheel = new game.image(getElem("wheel"), 35, 15, getElem("wheel").width * 5, getElem("wheel").height * 5);
			obj.backWheel = new game.image(getElem("wheel"), -35, 15, getElem("wheel").width * 5, getElem("wheel").height * 5);
			obj.nameText = new game.text(obj.name, 0, 0, "#EEE", "Arial", 22);
			
			scene.add(obj.visual);
			scene.add(obj.frontWheel);
			scene.add(obj.backWheel);
			scene.add(obj.nameText);
			players.push(obj);
		},
		function(obj) {
			//wheel position and rotation
			obj.frontWheel.position.x = obj.visual.position.x + Math.cos(obj.visual.rotation) * 35 + Math.sin(obj.visual.rotation) * -15;
			obj.frontWheel.position.y = obj.visual.position.y + Math.sin(obj.visual.rotation) * 35 + Math.cos(obj.visual.rotation) * 15;
			obj.backWheel.position.x = obj.visual.position.x + Math.cos(obj.visual.rotation) * (-35) + Math.sin(obj.visual.rotation) * -15;
			obj.backWheel.position.y = obj.visual.position.y + Math.sin(obj.visual.rotation) * -35 + Math.cos(obj.visual.rotation) * 15;
			obj.frontWheel.rotation += obj.vel / 20;
			obj.backWheel.rotation += obj.vel / 20;
			
			//smoke particles
			if (Math.abs(obj.vel) > 9) {
				if (obj.onTile == "road") {
					makeSmoke(obj.frontWheel.position.x, obj.frontWheel.position.y, 1);
					makeSmoke(obj.backWheel.position.x, obj.backWheel.position.y, 1);
				}
				else if (obj.onTile == "empty") {
					makeDirt(obj.frontWheel.position.x, obj.frontWheel.position.y, 1);
					makeDirt(obj.backWheel.position.x, obj.backWheel.position.y, 1);
				}
			}
			
			//moving name text
			obj.nameText.position.x = obj.visual.position.x;
			obj.nameText.position.y = obj.visual.position.y - 35;
		},
		function(obj, packet) {
			obj.vel = packet.vel;
			obj.onTile = packet.onTile;
			obj.roadsToTouchLength = packet.roadsToTouchLength;
			obj.laps = packet.laps;
		},
		function(obj) {
			scene.remove(obj.frontWheel);
			scene.remove(obj.backWheel);
			players.splice(players.indexOf(obj), 1);
		}
		);
		game.addType(
		"tile",
		function(obj, packet) {
			obj.visual = new game.rectangle(packet.x, packet.y, packet.width, packet.height);
			obj.visual.width = packet.width;
			obj.visual.height = packet.height;
			obj.visual.rotation = packet.rot;
			obj.tileType = packet.tileType;
			if (obj.tileType == "road") {
				obj.visual.color = "#333";
			}
			else if (obj.tileType == "finish") {
				obj.visual.color = "#999";
			}
			tilesScene.add(obj.visual);
		},
		function(obj) {
			
		},
		function(obj, packet) {
			
		},
		function(obj) {
			scene.remove(obj);
		}
	)
	
	function main() {
		//keyboard input and camera movement
		controls.changedKeys.forEach(function(key) {
			game.currentPackets.push({
				type: "updateControls",
				object: {
					key: key,
					state: controls[key]
				}
			});
		});
		controls.changedKeys = [];
		game.update();
		scene.camera.position = new game.Vector2(game.me.visual.position.x, game.me.visual.position.y);
		extrasScene.camera.position = scene.camera.position;
		tilesScene.camera.position = scene.camera.position;
		guiScene.camera.position = scene.camera.position;
		
		//updating particles
		for (var i = 0; i < particles.length; i++) {
			particles[i].position.x += particles[i].xvel;
			particles[i].position.y += particles[i].yvel;
			particles[i].rotation += particles[i].rotationRate;
			particles[i].opacity -= Math.random() * 0.025;
			particles[i].yvel -= 0.01;
			if (particles[i].opacity <= 0.01) {
				particles[i].dead = true;
			}
			if (particles[i].dead) {
				extrasScene.remove(particles[i]);
				particles.splice(i, 1);
				i--;
			}
		}
		
		//places
		players.sort(function(a,b) {
			if (a.laps < b.laps) return 1;
			else if (a.laps > b.laps) return -1;
			else {
				if (a.roadsToTouchLength > b.roadsToTouchLength) return 1;
				else if (a.roadsToTouchLength < b.roadsToTouchLength) return -1;
				else {
					if (a.vel < b.vel) return 1;
					else return -1;
				}
			}
		});
		
		//updating GUI
		if (gameOver) {
			gameOverText.position.x = game.me.visual.position.x;
			gameOverText.position.y = game.me.visual.position.y - 200;
		}
		else {
			lapCounterText.position.x = game.me.visual.position.x;
			lapCounterText.position.y = game.me.visual.position.y + renderer.topOfScreen + 50;
			if (game.me.laps !== undefined) lapCounterText.text = "Lap " + game.me.laps + "/5";
			placeText.position.x = game.me.visual.position.x;
			placeText.position.y = game.me.visual.position.y + renderer.bottomOfScreen - 50;
			var place = players.indexOf(game.me);
			if (place != -1) {
				placeText.text = place + 1;
				if (place + 1 == 3) placeText.text += "rd";
				else if (place + 1 == 2) placeText.text += "nd";
				else if (place + 1 == 1) placeText.text += "st";
				else placeText.text += "th";
			}
		}
		
		//rendering stuff
		renderer.clear();
		renderer.render(tilesScene);
		renderer.render(extrasScene);
		renderer.render(scene);
		renderer.render(guiScene);
		requestFrame(main);
	}
	
	game.addPacketType(
		"gameWinners",
		function (packet) {
			guiScene.add(gameOverText);
			guiScene.remove(lapCounterText);
			guiScene.remove(placeText);
			gameOver = true;
		}
	);
</script>